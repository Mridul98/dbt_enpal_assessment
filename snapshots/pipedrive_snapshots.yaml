snapshots:
  - name: deal_activity_types_snapshot
    relation: source('postgres_public', 'activity_types')
    config:
      target_schema: "{{ target.schema + '_pipedrive_snapshots' }}"
      strategy: check
      check_cols: all
      unique_key: id
      hard_deletes: invalidate
      tags: [pipedrive, pipedrive_snapshots]
      indexes: [
        {'columns': ['id', 'dbt_valid_from', 'dbt_valid_to'], 'type': btree}
      ]
      post_hook: "create index if not exists snap_deal_activity_types_current_idx \
        on {{ this }} (type) \
        where dbt_valid_to is null"
  
  - name: deal_fields_snapshot
    relation: source('postgres_public', 'fields')
    config:
      target_schema: "{{ target.schema + '_pipedrive_snapshots' }}"
      target_database: postgres
      strategy: check
      check_cols: all
      unique_key: id
      hard_deletes: invalidate
      tags: [pipedrive, pipedrive_snapshots]
      indexes: [
        {'columns': ['id', 'dbt_valid_from', 'dbt_valid_to'], 'type': btree}
      ]
      post_hook: "create index if not exists snap_deal_fields_current_idx \
        on {{ this }} (id) \
        where dbt_valid_to is null"
  
  - name: deal_users_snapshot
    relation: source('postgres_public', 'users')
    config:
      target_schema: "{{ target.schema + '_pipedrive_snapshots' }}"
      strategy: timestamp
      updated_at: modified
      unique_key: id
      hard_deletes: invalidate
      tags: [pipedrive, pipedrive_snapshots]
      indexes: [
        {'columns': ['id', 'dbt_valid_from', 'dbt_valid_to'], 'type': btree}
      ]
      post_hook: "create index if not exists snap_deal_users_current_idx \
        on {{ this }} (id) \
        where dbt_valid_to is null"
      
  - name: deal_stages_snapshot
    relation: source('postgres_public', 'stages')
    config:
      target_schema: "{{ target.schema + '_pipedrive_snapshots' }}"
      strategy: check
      check_cols: all
      unique_key: stage_id
      hard_deletes: invalidate
      tags: [pipedrive, pipedrive_snapshots]
      indexes: [
        {'columns': ['stage_id', 'dbt_valid_from', 'dbt_valid_to'], 'type': btree}
      ]
      post_hook: "create index if not exists snap_deal_stages_current_idx \
        on {{ this }} (stage_id) \
        where dbt_valid_to is null"
  